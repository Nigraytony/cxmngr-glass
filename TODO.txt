TO DO FOR THE APP
----------------------------------------
LAUNCH READINESS (Subscription + Public Use) — Prioritized

P0 (Launch blockers / security)
- [x] Enforce RBAC on all project-scoped read endpoints (Owner: Backend, Effort: M) — prevent cross-project data leaks (projects list/get now auth+member-scoped; do a final audit).
- [x] Add basic API rate limiting (login/reset/AI/uploads) without new deps (Owner: Backend, Effort: S).
- [x] Add baseline security headers (no deps) (Owner: Backend, Effort: S).
- [x] Add request validation on all write endpoints (no new deps; consistent helpers) (Owner: Backend, Effort: M) (expanded: uploads + AI + tasks import + broad ObjectId param guards across admin/projects/tasks/users/spaces/billing + core entities).
- [x] Ensure rich-text fields are sanitized on all create/update paths (Activities/Issues/Templates/etc.) (Owner: Backend, Effort: M) (started: Activities/Issues/Templates/Spaces/Equipment; continue audit).
- [x] Frontend: stop unauthenticated project list calls + ensure auth headers on all `/api/projects*` requests (Owner: Frontend, Effort: S).
  - Note: In production, CORS now requires `CORS_ALLOWED_ORIGINS` or a valid `APP_URL`/`FRONTEND_URL` (backend blocks arbitrary browser origins by default).
  - Note: Added validation/sanitization on `POST /api/projects` + `PUT /api/projects/:id`, invite id guards, and `POST /api/projects/addUser` input validation.
  - Note: Added validation/sanitization on Tasks (`POST /api/tasks`, `PATCH /api/tasks/:id`, `POST /api/tasks/import-template`, `GET /api/tasks` projectId validation).
  - Note: Added `projectId` validation on create endpoints for Activities/Issues/Equipment/Templates.
  - Note: Moved project id validation earlier via `requireBodyField` + `requireObjectIdBody` middleware for create endpoints (Activities/Issues/Equipment/Templates/Spaces), and sanitized MS Project task import notes.
  - Note: AI endpoints now verify the authenticated user is a member of the requested project before using project AI settings/key.
  - Note: Added `requireFeature(...)` + projectId-loading middleware to Issues/Equipment/Activity media endpoints (photos/attachments) so plan gating and RBAC apply consistently.
  - Note: Added `requireActiveProject` enforcement to Activity/Equipment log append endpoints (`POST /api/activities/:id/logs`, `POST /api/equipment/:id/logs`) for subscription consistency.
  - Note: Fixed plan gating on core update/delete endpoints by loading parent `projectId` before `requireFeature(...)` (Activities/Issues/Equipment/Tasks).
  - Note: AI endpoints now enforce active subscription (`requireActiveProject`) before processing `/api/ai/chat` and `/api/ai/suggest-tags`.
  - Note: Tasks list search now uses `buildSafeRegex` (escapes user input + caps length) to avoid regex ReDoS risk on `GET /api/tasks?q=...`.
  - Note: Projects invites email matching now uses a single safe helper (`buildExactCaseInsensitiveRegex`) and the duplicate `/api/projects/my-invites` route definition was removed.
  - Note: Task import endpoints no longer return internal `detail` in production (`POST /api/tasks/import`, `POST /api/tasks/import-template`).
  - Note: Core entity routes now avoid leaking internal error messages in production (Activities/Equipment/Issues/Tasks helper middleware + tasks list/get/delete failures).
  - Note: ID-loading middleware now returns 400 on invalid ObjectIds (Activities/Equipment/Issues) instead of bubbling to 500.
  - Note: Spaces list endpoints now validate optional `parentSpace` query param to avoid CastErrors/500s.
  - Note: Tasks templates listing now avoids leaking internal errors in production (`GET /api/tasks/templates`).
  - Note: Log append endpoints now normalize/size-cap log payloads via `backend-api/utils/logEvent.js` to prevent oversized/untrusted log entries (Activities/Issues/Spaces/Equipment/Projects).
  - Note: Project membership guard now validates ObjectId and skips invalid memberId lookups to avoid CastErrors/500s (`backend-api/routes/projects.js`).
  - Note: Tasks list now validates/clamps optional `activityId` filter to avoid unbounded query inputs (`GET /api/tasks?activityId=...`).
  - Note: List endpoints now allowlist `sortBy` fields to avoid invalid sort keys triggering Mongo errors (Templates/Equipment/Issues/Spaces).
  - Note: Projects list now allowlists `sortBy`/`sortDir` to avoid invalid sort keys triggering Mongo errors (`GET /api/projects`).
  - Note: Admin endpoints now avoid leaking internal errors in production by using `safeErrorMessage` for 500s (`backend-api/routes/admin.js`).
  - Note: Admin webhook events list now validates `date_from`/`date_to` query params to avoid invalid Date filters (`GET /api/admin/webhook-events`).
  - Note: Admin webhook replay now ignores malformed Stripe `projectId` metadata (avoids CastErrors on `Project.findByIdAndUpdate`) (`POST /api/admin/webhook-events/:eventId/replay`).
  - Note: Billing transactions endpoint now validates `start`/`end` query params (invalid dates return 400) (`GET /api/stripe/project/:id/transactions`).
  - Note: List endpoints now validate/clamp filter values (e.g., `type/system/status/priority`) to avoid oversized query inputs (Projects/Templates/Equipment/Issues/Spaces).
  - Note: List endpoints now treat empty/`All` filter values as “no filter” (instead of 400) while still rejecting oversized filters (Projects/Templates/Equipment/Issues/Spaces).
  - Note: Project-scoped management endpoints now enforce active subscription (`PUT /api/projects/:id`, `/api/projects/addUser`, `/api/projects/:id/resend-invite`, `/api/projects/:id/logs`, `/api/projects/:id/roles*`, `/api/projects/:id/team/:memberId/permissions`, and invite acceptance flows).
  - Note: Invite and password-reset acceptance flows now validate token format/length (`/api/projects/accept-invite`: 40-hex; `/api/users/reset-password`: 64-hex) to avoid unbounded query inputs.
  - Note: Hardened legacy plan-change route by requiring project-admin permission (`POST /api/projects/:id/change-plan`).
  - Note: Fixed admin user update to hash passwords correctly (avoid `findByIdAndUpdate` bypassing `User` pre-save hook) and added basic validation to admin audit/test-email/webhook-replay endpoints.
  - Note: Hardened local upload deletion to prevent path traversal when removing attachments (Activities/Issues/Equipment/Spaces/Templates now delete only within `/uploads/<type>/`).
  - Note: Hardened auth flows: registration no longer accepts client-supplied `role`/`projects`, and login no longer crashes on unknown emails; tasks template listing now validates `projectId` and enforces `tasks.read`.
  - Note: Hardened profile + password reset: validate email format/uniqueness on user update, validate email format on forgot-password.
  - Note: Fixed Space attachment delete to treat stored attachments as URL strings (not `{url}` objects) so local cleanup works.
  - Note: Added ObjectId param validation to `GET /api/templates/project/:projectId` and `GET /api/equipment/project/:projectId` to avoid CastError/500s.
  - Note: Hardened billing endpoints (`backend-api/routes/billing.js`): validate Stripe IDs (`price_`, `pm_`, `promo_`), cap promotion code length, allowlist `proration_behavior`, and enforce `projectId` presence/ObjectId on checkout/portal session creation.
  - Note: Fixed Stripe webhook processing (`backend-api/routes/webhooks.js`) to avoid incorrectly returning `202` for new events, and validate `projectId` before any `Project.findById*` calls to prevent CastError/500s from malformed metadata.
  - Note: Hardened plans admin endpoints (`backend-api/routes/plans.js`): validate project `stripePriceId` format before reconcile and stop returning internal error `details` in 500 responses.
  - Note: Hardened admin list + billing tools (`backend-api/routes/admin.js`): validate `projectId` on admin tasks/templates list filters, validate inputs for billing credits (amount/currency/userId/email/customerId), and validate Stripe `promo_` IDs + payload for promotion-code updates.
  - Note: Hardened templates CRUD (`backend-api/routes/templates.js`) by restricting create/update payloads to an allowlist and preventing client-side updates to `projectId`/media arrays (photos/attachments/issues) via the generic PATCH route.
  - Note: Hardened mass-assignment in core entities: Activities (`backend-api/routes/activities.js`), Equipment (`backend-api/routes/equipment.js`), Tasks (`backend-api/routes/tasks.js`), Spaces (`backend-api/routes/spaces.js`), and Projects (`backend-api/routes/projects.js`) now use allowlists for create/update and block client updates to protected fields (ownership, subscription/billing, logs, and media arrays).
  - Note: Removed remaining raw 500 error leakage from core routes (Activities/Equipment/Spaces/Issues/Templates/Projects) and tightened admin template create/update to use an allowlist (`backend-api/routes/admin.js`).
  - Note: Hardened RBAC middleware (`backend-api/middleware/rbac.js`) to validate `projectId` before `Project.findById` to avoid CastError/500s, and made `backend-api/routes/projects.js` Stripe initialization safe when `STRIPE_SECRET_KEY` is missing (plus validated plan-change inputs).
  - Note: Removed remaining raw error-object responses (`res.status(...).send(error)`) across routes and replaced with safe `{ error: message }` payloads with server-side logging (Users/Projects/Issues/Templates/Activities/Equipment/Spaces).
  - Note: Hardened subscription + plan guards (`backend-api/middleware/subscription.js`, `backend-api/middleware/planGuard.js`) to validate `projectId` before DB lookups, preventing CastErrors and leaking internal error messages.
  - Note: Hardened list search filters to avoid regex-injection/DoS by escaping and length-capping `search` into a safe `RegExp` (`backend-api/utils/search.js`) and applying across Issues/Templates/Spaces/Equipment list endpoints.
  - Note: Extended safe regex handling to admin task search (`backend-api/routes/admin.js`) and projects list search (`backend-api/routes/projects.js`) to avoid regex injection and cap search length.
  - Note: Extended safe regex handling to admin users/projects/task-templates search and `GET /api/tasks/templates` query (`backend-api/routes/admin.js`, `backend-api/routes/tasks.js`).

P1 (Revenue + support readiness)
- [x] Add “Billing Admin” UX + error messages for 402/plan limits across UI (Owner: Frontend, Effort: M) (global toast on 402/PLAN_LIMIT_REACHED via `src/utils/http.ts`).
- [ ] Add admin tooling for subscription support (project lookup, webhook replay, billing status) (Owner: Backend+Frontend, Effort: M).
- [x] Add “kill switch” flags for AI + email + uploads via env or admin settings (Owner: Backend, Effort: S) (env flags added; admin toggles optional).

P2 (Operational hygiene)
- [x] Add basic structured logging (request id, route, status; avoid PII) (Owner: Backend, Effort: M) (started: request-id + JSON request logs; removed verbose activity-create body logging).
- [ ] Add backups/retention plan for Mongo + uploads (Owner: DevOps, Effort: M).
- [ ] Add monitoring/alerting (errors + performance) (Owner: DevOps, Effort: M).

Notes
- “No new dependencies” means implement with Express/Mongoose + small helper modules.
- Items above should be completed before wider public launch.

✅ 1.  Issues: Update the Issues to pull them from the DB instead of static issues
✅ 2.  Issues: keep all issue interraction on the Issues page
✅ 3.  APP: Add Project CRUD to the app
✅ 4.  Side Panel: Update the side panel to highlight the page that is active
✅ 5.  Profile: Add Update Password logic to the app
✅ 6.  Profile: Add project Cards in th projects tab of the user profile
✅ 7.  Profile: Implement a Forgot Password functionality in the app
✅ 8.  Activities: Don't filter on projects. Only activities for the default project needs to be available
9.  Activities: Filter on Type and Start Date
✅ 10. Activities: Fix the equipment list - if there are assets with the same tag on a project it can't choose between/among them.
11. Activities: Add pagination to this page.Need a LIST view for activities.
✅ 12. Lists: All table sorting need to persist for the session
✅ 13. Lists: Pagination per page selections need to persist for the session
✅ 14. Spaces: All locations need to be displayed as breadcrumbed heirarchy
✅ 15. Equipment: Need to investigate why equipment list is being filtered when there is no filter
16. Equipment: Add charting in the equipment module to track progress. Maybe a colapsible panel that shows charts and percentage counst for equipment, checklists, and functional tests.
17. Equipment: Photo/File Upload tabs should be able to upload multiple files at once but feature not working. Need to fix.
18. Equipment: Need to add feature to bulk edit equipment. Maybe select what fields to be affected and checkbox selection of equipment.
19. Equipment: Reporting - need a Report component where we can select what fields/tabs to include and in what order.
20. Issues: In the Issues list, need to add equipment column (maybe an add column option)
21. Issues: In the reports the logos in the header are distorted. They need to keep their aspect ratio.
22. Tagging: Need to add a tagging feature throughout the app to help finding information/data quickly.
23. Documentation: We need to add a robust documentation and FAQ module for the app. It should cover that app and Cx very well.
24. Logging: Finish the logging features of the app and make it one that loggs everything for transparency and research.
25. Tasks: Fix the gantt feature so that we have a good working gantt chart for each app.
✅ 26. Tasks: The app needs the ability to tie a task to an activity in a 1:1 relationship. A completed Activity will mark the task as complete.
✅ 27: Tasks: Update the Dashboard with Tasks information.
28. Tasks: Include an attactive calendar view for tasks.
29. Tasks: Export tasks to xlsx, csv, xml, mpp, and pdf files.
30. Email: Build out the email functionality to include emails for industry typical actions.
31. Email: Create an Email module where the app can create/modify email templates for the different emails.
✅ 32. Stripe: Update the implementation so that it is accurate and complete for what is needed for the project subscriptions.
✅ 32: Stripe: Add a transactions tab for each project to view all the past transactions on that particular project. More description when we start this task.
33. Stripe: Add live account with features-based subscriptions, coupons, and discounts.
34. Admin: build out the admin pages more. Give super/global admins window into projects and billing using consent token/key
✅ 35. Administration: All new users get a "user" role on registration - admin role is granted by global/super admins only. Project-based roles are separate.
36. Administration: Setup email/smtp service on Azure.
37. Administration: Purchase a domain name for cx-manager.com and tie it to the app.
38. Administration: Create a Cx Manager entity for legal compliance.
39. Bug Fix: When Issues are created from within an equipment it is placing the equipment tag in the location field and vice versa. Need to fix.
✅ 40. Bug Fix: When entering Edit pages we need to show a spinner while the page loads.
✅ 41. Bug Fix: Cannot upload photos in the IssueEdit.vue Photos tab.
✅ 42. Templates: Add the ability to upload templates from a csv or an xslx file.
43. App: Fix ghosting when a modal is open
✅ 44. App: Allow the main area to scroll while leaving the sidebar as is (stationary).
45. App: Add footer at bottom of page.
✅ 46. Tasks: Remove Gantt feature for now. We can come back to it in a later version of the app.
✅ 47. Tasks: Collapse All needs to show at least one task.
✅ 48. Tasks: Opt-out of auto cost needs to be added to each task.
49. Tasks: Add an optional Travel section to each task that helps to calculate travel cost of a task if needed.
50. Tasks: Make this task list into a component and then Use it for other features such as LEED/Fundamental/Enhanced Cx Tasks, Project Tracking, and Proposals
✅ 51. Admin: Enable Features based on subscription level
52. Admin: Offload photo and files from the server to an S3 bucket or Azure equivalent.
53. Mobile App: Start investigating what it would take to spinup a mobile app from this web app.
54. Desktop App: Start investigating what it would take to spinup a desktop app from this web app.
55. AI: Post-MVP, add blueprint/PDF ingestion flow that reads uploaded drawings and proposes draft Spaces/Equipment lists for user review.
56. Bug Fix: Dropdown lists are white text on white background. Needs to be fixed throughout the app.


Please remember that:
You are a senior full-stack engineer collaborating with me on a production-grade web application.

STACK & CONTEXT
- Frontend: Vue 3, Composition API, single-file components (.vue), TypeScript optional, Pinia/Vue Router likely.
- Backend: Node.js, Express, Mongoose (MongoDB).
- Environment: VS Code, Git, npm, modern JS/TS tooling.
- Goal: Produce reliable, clean, *runnable* code that minimizes bugs and rework.

GENERAL BEHAVIOR
- Think and act like a senior engineer, not an autocomplete.
- Optimize for correctness, clarity, and maintainability over cleverness or brevity.
- If you are uncertain about an API or detail, say so explicitly. Do NOT invent APIs or magic functions.
- Prefer simple, robust patterns over over-engineered abstractions.

WHEN I ASK FOR CHANGES OR FEATURES
1. First, restate the task briefly in your own words so we confirm alignment.
2. Identify the relevant files, components, routes, and models that are likely involved.
3. Propose a short plan (3–7 bullet points) before writing code.
4. Then implement the plan in code.

CODE STYLE & PRACTICES
- Use modern JavaScript/TypeScript syntax (async/await, const/let, arrow functions).
- For Vue 3:
  - Use <script setup> with Composition API unless I explicitly say otherwise.
  - Keep template, script, and style sections well structured.
  - Avoid unnecessary global state; use props/emits and composables sensibly.
- For Express/Mongoose:
  - Separate concerns: routes, controllers/handlers, services, models.
  - Use async/await and proper try/catch or error middleware.
  - Validate inputs before hitting the database (basic validation at minimum).
  - Avoid leaking internal error details to the client.

SELF-REVIEW PASS (MANDATORY)
After you generate code, perform a mental “lint and review” pass and FIX issues yourself before finalizing. Specifically:

- IMPORTS & EXPORTS
  - Ensure all used symbols are imported or defined.
  - Remove unused imports.
  - Ensure default vs named exports are consistent with usage.

- VARIABLES & FUNCTIONS
  - Ensure every variable and function you reference is defined.
  - Ensure no typos in variable, prop, or field names.
  - Ensure async functions are awaited where needed.

- FRAMEWORK CORRECTNESS
  - For Vue: check that refs/reactive/computed are used correctly; template matches script names.
  - For Express: check route paths, HTTP verbs, middleware order, and that handlers send a response in all branches.
  - For Mongoose: check model names, schema fields, query usage (e.g., find, findOne, findById, updateOne, etc.) are syntactically valid.

- DATA FLOW & TYPES
  - Ensure request/response payload shapes are consistent between frontend and backend.
  - Ensure field names match across schema, controller, and frontend usage.

- ERROR HANDLING
  - Avoid silent failures.
  - Use try/catch around async DB calls or I/O and propagate errors cleanly.

OUTPUT FORMAT
- When creating or replacing a file: provide the *full file content* in a single code block.
- When editing an existing file and the change is small:
  - Either show the full updated file, or
  - Show a clearly marked diff or only the changed sections with enough surrounding context, according to what I ask for.
- Include brief comments in code where the logic is non-obvious.

WHEN YOU LACK CONTEXT
- If the task depends on code or configuration you cannot see, do NOT guess.
- Instead, clearly state what assumptions you are making.
- If a key detail is missing (e.g., exact schema shape, route prefix), call it out and propose reasonable defaults BUT label them as assumptions.

TESTING & USAGE
- When adding a new function, route, or composable:
  - Provide at least one short usage example (or example API call) so I can quickly test it.
- For API endpoints:
  - Show an example request (e.g., curl or fetch/axios snippet) and expected JSON response shape.

TONE
- Be concise but not cryptic.
- Favor practical guidance over theory.
- When something is risky or suboptimal, say so and suggest a better alternative.


Assistant module
The assistant module is cxma's way of guiding the CxA/admin through the commissioning process to meet the project scope and remain LEED/ASHRAE/Cx compliant.

IP / Copyright safety (Assistant)
- Default behavior: store only CXMA-authored guidance, plus links/citations to official sources. Do not copy/paste copyrighted standards text into CXMA.
- Future “user uploads standards PDF and ask questions” requires explicit licensing/terms review + strict safeguards (project-scoped, no redistribution, excerpt limits, retention/deletion).

UI/UX (global + dedicated page)
- [x] Floating "Ask Assistant" button visible across `/app/*` pages (opens modal; does not reroute).
- [x] Modal includes "Open full Assistant" option (routes to `/app/assistant`).
- [x] First-run closable intro/notification (persisted client-side).
- [x] Dedicated `/app/assistant` page scaffolded as split layout (checklist left, docs/chat right).
- [x] Assistant available to all subscription plans (AI features gated separately).
- [x] Provide a compliance checklist UI (checkable, visual completed state; card click selects, checkbox toggles).
- [x] Provide checklist CRUD:
  - [x] Add custom checklist item (icon button in header).
  - [x] Delete checklist item (hides seeded items via persisted `hiddenItemIds`).
- [x] Provide recommended actions:
  - [x] Quick import tasks from template (project-type aware).
  - [x] Dismiss/hide individual recommended actions (per-user/per-project, persisted client-side).
- [x] Provide context-driven documentation panel (trusted sources only + CXMA platform guidance + deep links).
- [x] Add long-form Assistant articles (authorable) with browse + search when no checklist item is selected.
- [x] Admin UI for Assistant articles CRUD (`/app/admin/assistant-articles`) including author field.
- [ ] Provide tips/coachmarks throughout app via toasts/alerts (non-spammy; per-user dismissal).

AI behavior (plan-gated)
- [x] Chat UI wired to existing AI store/providers (OpenAI/Gemini/Claude).
- [x] Ask Assistant modal chat panel scrolls (send button stays visible).
- [x] AI chat integrates with Assistant docs panel (grounding/context selection + trusted links).
- [x] Production stability: chat visibility uses `/api/ai/status` (not only cached `currentProject` plan fields).
- [x] BYO key: Project AI Settings can save/test encrypted project keys (requires `AI_ENCRYPTION_KEY` on backend).
- [ ] Auto-tagging + extraction flows exposed in UI (where relevant).
  - [x] Editor auto-tag: "Suggest tags" in taggable edit pages (project tag library only).
  - [x] Bulk auto-tag: "Auto-tag this page" on list pages (Tasks/Issues/Equipment/Activities/Spaces).
  - [x] Bulk auto-tag empty state includes quick link to Project Settings tag library.
  - [ ] Extraction flows (e.g., extract draft checklist items/tasks/activities from uploaded content) — future.

Project-driven behavior
- [x] Read `project.type` and suggest/offer automated actions (task templates, compliance guidance).
- [x] "Generate tasks from project type" action (Quick import tasks from template; project-type aware).

Permissions & safety
- [x] Enforce assistant project access server-side on assistant endpoints (project-scoped; requires active project).
- [x] Enforce stricter assistant scope restrictions for AI chat/tooling (project-scoped only; plan-gated; server-side guardrails + disallowed request detection).
- [x] Never allow: PII handling, sending emails, billing changes, destructive actions (server-side preflight refusal in `/api/ai/chat`).
- [ ] Require explicit confirmation before destructive actions (delete tasks/activities/etc).

Chat storage
- [x] Persist chats per-project (visibility: project members; Premium-only).
- [x] Decide retention policy (90 days rolling TTL, capped at 300 messages per project).
- [x] Export/delete controls (currently: no).

Polish (button overlap fixes)
- [x] Avoid "Ask Assistant" covering key bottom action bars (TaskEdit/EquipmentEdit/TemplateEditor).
- [x] Avoid "Ask Assistant" covering pagination controls (SpacesList/EquipmentList/IssuesList).
